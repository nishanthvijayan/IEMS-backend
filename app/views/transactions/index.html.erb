<h2 class="center">View Logs</h2>

<!-- This list of privilages is only in dev environment -->
<% if Rails.env.development? %>
<div class="container center row">(
	<h5>Admin: <b><%= if  current_user.admin? then "Yes" else "No" end%></b></h5>
	<h5>Manager: <b><%= if  current_user.manager? then "Yes" else "No" end%></b></h5>
)</div>
<% end %>

<div class="btn-group pull-right" role="group" aria-label="...">
	<%= content_tag 'span', 'Export as ', class: 'export-text btn btn-success' %>
	<%= link_to 'CSV', regular_user_transactions_path(regular_user_id:current_user.id, format: 'csv'), class: 'btn btn-success' %>
	<%= link_to 'Excel', regular_user_transactions_path(regular_user_id:current_user.id, format: 'xls'), class: 'btn btn-success' %>
</div>

<br><br><br>
<br>
<div class="panel  panel-default">
	<div class="panel-heading">Filters</div>
	<div class="panel-body">

		<%= search_form_for [current_user, @q], :html => { :class => "form-inline" } do |f|%>
			
			<div class="form-group col-lg-3">
				<div class="input-daterange input-group" id="datepicker">

				<%= f.text_field :date_gteq, class:"input-sm form-control", id: 'start', placeholder: 'Start Date' %>
				<span class="input-group-addon">to</span>
				<%= f.text_field :date_lteq, class:"input-sm form-control", id: 'end', placeholder: 'End Date' %>
				</div>
			</div>

			<div class="col-lg-2">
				<div class="input-group select-group">
					<%= f.select :regular_user_id_eq, options_from_collection_for_select(@regular_users, 'id', 'name'), { :include_blank => 'All Users' }, { :class => 'form-control' } %>
				</div>
			</div>

			<div class="col-lg-2">
				<div class="input-group select-group">
					<%= f.select :guest_user_id_eq, options_from_collection_for_select(@guest_users, 'id', 'name'), { :include_blank => 'All Guests' }, { :class => 'form-control' } %>
				</div>
			</div>
			
			<div class="checkbox col-lg-3">
				<label><%= check_box_tag('q[food_type_eq_any][]', 'B') %>Breakfast</label>
				<label><%= check_box_tag('q[food_type_eq_any][]', 'L') %>Lunch</label>
				<label><%= check_box_tag('q[food_type_eq_any][]', 'D') %>Dinner</label>
				<label><%= check_box_tag('q[food_type_eq_any][]', 'S') %>Special</label>
		  	</div>

			<div class="col-lg-2">
				<%= f.submit 'Search', class: 'btn btn-success' %>
			</div>

		<% end %>
			
  	</div>
</div>

<div class="panel  panel-default">
	<div class="panel-heading">Stats</div>
	<div class="panel-body row">
		<div class="col-lg-4">
			<div id="cal-heatmap"></div>
		</div>

		<div class="col-lg-2 col-lg-offset-1">
			<canvas id="guestChart"></canvas>
			<ul class="legends pull-left">
				<li id="legend-regular"></li>
				<li id="legend-guest"></li>
			</ul>
		</div>

		<div class="col-lg-2 col-lg-offset-1">
			<canvas id="foodChart"></canvas>
			<ul class="legends pull-left">
				<li id="legend-breakfast"></li>
				<li id="legend-lunch"></li>
				<li id="legend-dinner"></li>
				<li id="legend-special"></li>
			</ul>
		</div>
	</div>
</div>

<table class="table table-bordered table-hover">
	<thead>
		<tr>	
			<th>#</th>
			<th>Photo</th>
			<th><%= sort_link(@q, :date, 'Date', default_order: :desc) %></th>
			<th>Food</th>
			<th><%= sort_link(@q, :price, 'Price', default_order: :desc) %></th>
			<% if current_user.admin? || current_user.manager?%>
				<th><%= sort_link(@q, :regular_user_name, 'Billed User', default_order: :asc) %></th>
			<% end %>
			<th><%= sort_link(@q, :guest_user_name, 'Guest Name', default_order: :asc) %></th>
		</tr>
	</thead>
	<tbody>
	<% @transactions.each_with_index do |transaction, index| %>
		<tr>	
			<td><b><%= index+1 %></b></td>
			<td><span class="glyphicon glyphicon-camera"></span></td>
			<td><%= transaction.date.strftime("%a %d %B, %Y") %></td>
			<td><%= full_food_type(transaction.food_type) %></td>
			<td><%= transaction.price %></td>
			<% if current_user.admin? || current_user.manager?%>
				<td><%= transaction.regular_user.name %></td>
			<% end %>
			<% if transaction.guest_transaction? %>
				<td><%= transaction.guest_user.name %></td>
			<% end %>
		</tr>
	<% end %>
	</tbody>
</table>

<div class="center">
	<%= will_paginate @transactions %>
</div>

<script type="text/javascript">

	var parser = function(data) {
		var stats = {};
		for (var d in data) {
			stats[data[d].date] = 1;
		}
		return stats;
	};

	var cal = new CalHeatMap();
	cal.init({
		data: window.location.href.replace(window.location.pathname,window.location.pathname+'.json'),
		afterLoadData: parser,
		domain: "month",
		subDomain: "day",
		range: 4,
		itemName: ["entry", "entries"],
		start: new Date(<%= 100.days.ago.to_i  * 1000 %>),
		cellSize: 17,
		domainGutter: 5,
		domainMargin: 5
	});

	var createUserTypeChart = function(){
		// Get context with jQuery - using jQuery's .get() method.
		var guest_ctx = $("#guestChart").get(0).getContext("2d");

		$.get( window.location.href.replace(window.location.pathname,window.location.pathname+'.json'), function( response ) {
			var guestCount = 0;
			var regularCount = 0;

			for (var i in response) {
				if (response[i].guest_transaction){
					guestCount += 1;
				}
				else{
					regularCount += 1;
				}
			}

			var doughnutData = [
				{
				  value: guestCount,
				  color:"#F7464A",
				  highlight: "#FF5A5E",
				  label: "Guests"
				},
				{
				  value: regularCount,
				  color: "#46BFBD",
				  highlight: "#5AD3D1",
				  label: "Regular"
				}
			];
			var myDoughnutChart = new Chart(guest_ctx).Doughnut(doughnutData);
			$("#legend-guest").append("Guest: "+guestCount);
			$("#legend-regular").append("Regular: "+regularCount);
		});
	};

	var createFoodTypeChart = function(){
		// Get context with jQuery - using jQuery's .get() method.
		var food_ctx = $("#foodChart").get(0).getContext("2d");

		$.get( window.location.href.replace(window.location.pathname,window.location.pathname+'.json'), function( response ) {
			var breakfastCount = 0;
			var lunchCount = 0;
			var dinnerCount = 0;
			var specialCount = 0;

			for (var i in response) {
				if (response[i].food_type == 'B'){
					breakfastCount += 1;
				} else if (response[i].food_type == 'L'){
					lunchCount += 1;
				} else if (response[i].food_type == 'D'){
					dinnerCount += 1;
				} else if (response[i].food_type == 'S'){
					specialCount += 1;
				}
			}

			var doughnutData = [
				{
				  value: breakfastCount,
				  color:"#8bc34a",
				  highlight: "#aed581",
				  label: "Breakfast"
				},
				{
				  value: lunchCount,
				  color: "#ff4081",
				  highlight: "#ff80ab",
				  label: "Lunch"
				},
				{
				  value: dinnerCount,
				  color: "#FDB45C",
				  highlight: "#FFC870",
				  label: "Dinner"
				},
				{
				  value: specialCount,
				  color: "#949FB1",
				  highlight: "#A8B3C5",
				  label: "Special"
				}
			];
			var myDoughnutChart = new Chart(food_ctx).Doughnut(doughnutData);
			 $("#legend-breakfast").append("Breakfast: "+ breakfastCount);
			 $("#legend-lunch").append("Lunch: "+ lunchCount);
			 $("#legend-dinner").append("Dinner: "+ dinnerCount);
			 $("#legend-special").append("Special: "+ specialCount);
		});
	};
	createUserTypeChart();
	createFoodTypeChart();
</script>
