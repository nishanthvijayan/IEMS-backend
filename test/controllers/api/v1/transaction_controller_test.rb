require 'test_helper'

module Api
  module V1
    class TransactionControllerTest < ActionController::TestCase
      def setup
        @client = Client.create(name: 'testclient', password: '123456789')
      end

      test 'saves new transaction on submitting valid data' do
        assert_difference 'Transaction.count', 1 do
          post :create, transaction: {guest_transaction: false, regular_user_id: 1, food_type: 'D', price: 100, date: '29/3/2016'}, access_token: @client.auth_token
        end
        json = JSON.parse(response.body)
        assert_equal json.keys, %w(id guest_user_id regular_user_id guest_transaction food_type date price image created_at updated_at)
      end

      test 'displays error and does not save new transaction on submitting invalid/incomplete data' do
        assert_no_difference 'Transaction.count' do
          post :create, transaction: {guest_transaction: false, regular_user_id: 1, food_type: 'D', date: '29/3/2016'}, access_token: @client.auth_token
          json = JSON.parse(response.body)
          assert_equal json.keys, ['status', 'message'], json.inspect
        end
      end

      test 'saves new transaction on submitting valid data with image' do
        assert_difference 'Transaction.count', 1 do
          post :create, transaction: {guest_transaction: false, regular_user_id: 1, food_type: 'D', price: 100, date: '29/3/2016', image: 'data:image/png;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDADUlKC8oITUvKy88OTU/UIVXUElJUKN1e2GFwarLyL6qurfV8P//1eL/5re6////////////zv//////////////2wBDATk8PFBGUJ1XV53/3Lrc////////////////////////////////////////////////////////////////////wAARCAHgAoADASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwCjRRS0AJRS0UAJRS0UDCiiloASiiikAUYopaAEopaKAEopaKAEpaKKACiiigAopaKACiiigBaWkpaBj0OGFXYmyKoCrUJ4poTLQpaYDS5pkjqWm5paAFoxRRQMKKWigBKKWigBKMUtFAhKMUtFACYopaKAExRS0YoATFGKXFGKBiYpKdRQA2ilooASjFLiigBMUmKdRQA3FGKdSUAJijFLiigQmKTFOooGNxRinUlACYpMU6igBuKMU6igBtJTqKBDaKdSUDExRS0YoATFJinUUANxRilooENxSYp9JigZlUUUuKQBRRRQMKKKKQBRRRTAKKKKQBRRS0AJRS0UAJRS0UAJS0UUDCiiigQUUUUDClpKWgApaSlFAC1PEcVCKkSgRbU8U6oVanhqYh9LmmhqXNADs0uabRTEOzS5puaWgY7NFNozQA6lpuaXNAC0UZooEFFFLQAlFLRQAlFLRQAmKKWigYmKMUtFAhtFLRQAlFLRQAlFLiigBtFLRQAlFLiigYmKSnUYoAbRS0YoEJSU7FJigApKWigBMUUtGKAEpKdSUDEopaKAG0U6koEJSU7FJigDIpaKKQwooooAWiiigYUUUUAFFFFIAooooAKKKKACiiigYUUUUCCiiigApaKKBhRRRSAKWilFACipEpgqRKYEgp1NFLQSOzShqbS0APDU4NUVLmncCXNLUQNKGoAkpaYGpwNAC0UZooEGaUNSUUDHZpc0ylpiHZpaZS5oAdRSZozQAtFGaKBhRRRQAUUtJQAUUUUCCiiigBKMUtFACUYpaKAEopaKBjaKWigQlFLijFACUlLRQMbiinYpMUCEopaKAEopcUYoAbiinUlADaKXFJQMx6WkopALS0lFABRRRQMKWkooELRSUtAwopM0ZoAWim5ozQAuaM02lpALRSUUAOopKWgApaSigBaKKKBi0opKcKAFFSrUaiplFAMcKWkpaCQoopaYBRRRQAtLTaWkAtKDTaWgB2aUNTKWgCQGlzUeaUGmBJRTM04GgBaKM0UAFLSUUALS0lFMBaXNNpaAFpabRQIdRSUUgFopM0tABRRRQMKSlooEJRS0UDEopaKYhKKKKAEopaKAEoxS0UANxRinUUANopaKAG0UtGKAEpKdSGgDDzRmmUc0hj80ZpmTRk0ASZpM03NJzQMkzRmmUUCHZo3U3FGKQC7qM0mKXFMYZpaMUYoAKM0YoxSAWijFKKAClpKWgAoopRQMKUUlKKAFpRSCnCgB6ipVpiipBQIWikpaYhaKKKACiiloASloooAKKKWgAooopALmlFNpaAFpaSloAXNKGptLQA7NLmmUuaYD6KaDRmgB1FJmloAKXNJS0AFFFFABS0lFAC0UUUAFLSUUALRSUUALRSUtABRRRQIKKKKBhRRRQISilooASilopgNopaKAEpKdikxQBz9GKWipGJilpaKYCYoxS0tIBuKXFLRigBMUYpQKXFAxMUYpaMUAJS0YpaAEopaKAEpaKKACiiigApaSloAKWkpRQMUVIopgqVRQIeop1IBS0CClpKWmAUtJS0ALRRRQAUtFFABRRRQAUUUUALRRiloAKKKWgAoopRQAUtJS0gCiiigBaM0lLQAuaM0lFADs0uabRTAdS03NGaAHUUmaWgAooooAKKKKACiiigAooooAWikooAWikpaACiiigAooooAKKWkoASilooEc9S0UUhi0UUUDCilooAKKKWgBKWiigAooooAKKKKACiiigAooooAKKKKAClpKWgAFOFIKcKAHqKlApiinigBaWkpaYgpaSigBaWkpaAFopKWgBaKKKACiiigBaKKKACloooAWiiigApaKKACilooASloooAKWkooAWjNFFIApaSigBaKSloAKXNJmigBc0uabS0AOzS0yjNMB9FNzS5oAWkpc0UAJRS0YoASilpKACiiigApaSigBaKKKBBRSUUDOfpc07FJtosFwopMEUZoAdRSZpc0hi0UlKKACiiigAooooAKKKKACiikoAWikpaACiiigBaBRSigBRT1FNAqRRQA8CnUgpaBBS0lLTAKWkpaAClpKWgBaKKKAClpKKAFoopaAClpKWgApaSloAKWkpaACilooAKKKKACiiigApaKKACiiigAopaKAEopaKACiiigAooopAFLmkooAWikooAdRmkzRmgB2aXNNooAdRSUZpgLRRmjNABRRRQAlFLRigBKKWkoAwsUoopaoQmKMUtGKBDStN5qSjFKw7keaXNO2ikK0rDuGaXNN2mk5FAD6KbmjdSGOopuaM0ALRSZozQAtFJS0AFGaMUYpgKDSg03FKKQXJV5qVRUSGphQAtLRRTELRRRQAUtFFABS0lKKAFooooAKWkooAWikyKXNAC0tIKWgBaKKKAFoopaACijFFABRRS0AFFFFABRRRQAUtJS0AFFFFABRRRQAUUUUgCiiigBaKKKACkpaKAEoxS0UAJSg0YoxQAuaKSloAWikozQAtGaM0UALmjNJRQA6kpKM0wMMUuaSiqELS02loAWikozQAtFFFAgoxRRQAm0UmwU6ilYY3ZRtp1JRYLibRRgUtJRYAozSUUAGaM0UUhhS0lKKAJIxU4qKMVMKAFooooAWiiigBaWkooAWikzRkUAOopu4etN81R3oC5JTHbFNMyjvUUkoI4NAXGvIc8GhZ2U8nIqEk5ooAurcLS/aVFUeaXmgdi+twh4zUoYHpWVg1IkjoeDQI06KqJcnuKlFwvegCfNFReenrSCdCeooAmpajEinuKduFADqKTI9aMigBaKTcKNw9aAHUUmRRmgBaKKKACiiigAooooAWiiigAooopAFFFLTASloopAFFFFABRRRQAUlLRQAlLRiigAopaSgBaSikoAxaUUlLViCiiigQUUUUDCjNJRQAuaM0lFAC5ozSUUBYXNNJpaSgAzSUUUgFpKKSgYtLmm5pM0gH04VGDTlNAFhBUoqKOpaAFpabuAprSgd6AJM0hcCqzT+lRGQnvQIttMo71G1xVXOaKBkxnJpvmMe9R0tAWHbj60ZptFADqKSigBaWkozSGLRmkpaAFzS5plLQA7NLuptFADt1GRTKM0AOB9DTt7joxqLNKDTuA/zpB3o+0yetNzQcUXFYPtEnrSec/8AeNIVB6UhUii4EguZB/FT1u5B71Wxiii4F5L3+8KsR3SPxnmsmlBoA2wwPelrIjuHToc1Yjvf71AGhSVFHOrjg1LnNAC0UUUAFFFLQAUUUUAFFFFABRRS0gCiiimAUUUUAFFFFIAooooASilpKAMSilpKskKKWkoGFLRSUALSUUUAFFFFAhaSlxSUDEooNITSAKQmkJppNADs0maSikMKWkpaAClBxTaKAJVkIpTO1Q0UASGQnvTd2abRQAuaKKKACloooAKKKKAFooooAKWiikMKWkpaAClpKWgYlLRRQAUtJRQAUlBpKBC0lJmloAM0UUUAGaUNTTSUxEnBpCtIDTqQxmKSpKQigQyjNLikpgOVyvQ1aivCOGqnRQBsRzq4yDUoOaxFcqcirkF1zhqANGimIwIp9ABRRS0gCiiimAUUUUAFFFFIAooopgFFFFABRRRSAKSlpKAMWkpcUlaCCiijFIAooxTgKAEoxS0UAGKKM0hNAhTTCaRmphNK4xxNNJoopDEopaKAEpaKKQCUUUUwCkoooAKKKKAClpKWgBaKKWgAooopAFFFFMAzS0lFAC0tJRQMWlpKWkAtFJS0DCiiigBaQ0UUANNJSmm0CCgGigUxC0tJS0hiGkpaQ0CAU8GoxTxTGOopKWkAU3FOpKAGkUlPppFACUZopKYi1b3JQ4Y8VpRyBhkGsSp7ecxnBPFAGwKWoon3CpRQAUUUUAFFFFABRRRQAUUUUAFFLRQAlFLRQAlFLSUgMSiilxWghMUYpaKQgoooNABSUhamE0XGOJphNFFTcYlFLRSASilopgJRS0lABSUtJSAKSiimAUUUUAFFFLQAUtApaAEpaSloAKKKKQwoopKYhaKSloABS0lLQMWiiikAtLSZooAWiiigApKWm0ABppp1IaAG5oFBoFMQ4UtAopAIaaacaaaYAKcKaKcKAHClpBS0hhSUtFACUUUUANIppp9NNACUtJQKYi7aTEHaa0kbIrCRirAitS1mDr1oAt0UgOaWgApaKKACiiigAooooAKKKKACiiigApKWigDFxRRR0qyRKM00tTSaQxxamk0lFSMKSilxQAlLS0lABSUtFACUUUUAFJS0lIBKKKSmAUUUUAFFFFABS0lLQAopaSloASlpKWgAooooGLTTTqSgBKWkpRQIKKKKAFpaSigYUZpKUUgFzS0lFAC0lFFABSUUUwEIoAxS0lAhwopKKAENNpTSUAKKcKaKeKAFpaKKQwooooASilpKBhSGnU00CGGkpxpKYgFSxSFGyKipRQBsQTB1FWAc1kW0u1sHvWnG2RQBLRRRQAUUUUAFFFFABRRRQAUUUUAFFFFAGIWpham5op3AWkpaKQCUUUUAFLSUtAwooopAJRS0lAgpKWkpgFJS0lACUlKaSgApaSloASiiigBaWkpaAClooxQAUlOppoAKWkpRQAtFApTQMaaBRQKBBRS0lABRmikoAWjNJRQMcDThTBTxSATFFOxSEUANpKdikNADaWiigQUUUUwENJS0AUAKKcKQCnCkMWlpKWgYUlLSUAFJS0lAC0hpaSgQ00004000CAUUlLTAcDitC1nyoBPNZ1SRttYUAbanIp1Vrd9yirIoAKKKWgAooooASloooAKSlooASiiigDn6KKKAClpKWgYlFFFIBaKKKYBRRRQAUlLRQISkpaSgApKWkoAQ0lKaSgBaKKKAEpaKKAFopaKAClFGKKAFpppaQ0AJSikpRQA4UGgUGgY00CinCgQUlLRQMSkpaKBCYoApaUUDACnAUCnAZpDACl20u2nYoGRFaaRUxFNK0CsQ4pMVKUpCtAWI8UU7FGKBDcUoFLilAoEIKcBQBS4oGApaKKBiUlLRQAlFFFABSGlooAaaYaeaaaBCUCkpaYhaUUgpaANCzfgDvV9TxWRbE+ZgVqRnIoES0UUUDCiiigAooooAKKKKAEooooA5+iiigBaKKKAEopaKACiiigYUUUUhBRRSUxhRS0lACUUtJQIQ02nGm0AKKKKKAEpaSloAcKKQUtAC0opKWgANNpaSgAoFLQKAFFBpRQaAG04U2lFAAaSn0mKBiUUUZoEJSikpQaBjxUi0xakWgYoFOApRTqAGbaTbTiaTdSGNK00rTy1NLUAMIppFOJpCaBDcUCigUxDhRSCnCgYCiiikAlJSmigBKKKKACkNLSGgBppppTSUxCUUUUCFFLSUtAD4jhwa14WyKyIx84rWg6CgRYFFIKWgYUUUUAFFFFABRRRQAlFLSUAc/S0UUDDFFFLSASilopgFFFFIBKKWkpgFFFFABSUtFACUlLRQIQ02nU00AAooooASlxRRQAoFLRS0AFLSUUAFFFKKACilopDCkJpaaaYBSikpwoAWkpaTFACUlP200igQ00ClxShaBj1qRaaop3SkMeGoLVGTSZoAeWppamk0lAClqTNJSUALmkzSUlAhSaAaSkpiJAacKjFPFAx1FApaQxKSnUmKAEopcUlABSGnUhoERmmmnmmGmAlLSUtAgpaSloAlhGXrUh6CsyD74rUi6UCJhS0gpaBhRRRQAUUUUAFFFFABSUtFAHP0UUtIYUUUUAFLRRQAUUUUAJRS0lACUUtFACUUtFACUlLRTENpCKdSGgBtLSUooASiloxQACnU2loAWiiigAoFFFADqM0lFAwNJRRQIBS0lLQAopwFNAp4oAXFBFLSZoGNxzSgCgmkoGPzSE0gpcUgEpKcabQIKTNBNNJpgGaM0lJQIdSUUUhiUUUUxDhT1pi1IooAcBS4pQKMUihKSnUlACUlLRQAlIaWkNAhhphp5phpiEpaKKAFoFApQMmgCxarl8+lacY4qnapgZq8g4oEPooooGFFFFABRRRQAUUUUAFFFFAGAKWjFFIYlLRRQAUUUUALRRRQAUlLRQMSiijFAgooooASiiigBKSnUlMQ0im08000AApaQUtACUUtFAAKWkooAWiiloAKKSigAopaKAEpwoFLQAopwptFAx2aSigUAGKAKcBQKAACg0tFAxhpDTjTTSENNNNKaaaYBmim96eBQIKDTgKCKBjDSUppBQIetSpUSiploAeKWgUtBQ002lNFACUlLRQAhpppSaYTSENNJQTSUxBRRRQAoqaFNzColUk8VftosDJpoRYhTAqwBTUXAp9IYUUUUAFFFFABRRRQAUUUUAFFFFAGFRRSgUhiUUtFACUUtFACUtFA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vFWBQIWnCm05aBjxRRRQAUUUUAFFJRQAtFJRQAtFFFABRRRQAUUUUAFFFFABRRRQAUUUUAFFFFABRRRQBjZoppak3ZqiR+aQtTetLigAyaUCgUoFACUtLil6UAIAaUClzSUXAcKWkApaVykgoxRRU3HYWikpaAClpKUUCY6ikopiFooooAWiiigAooooGFLRQKAFFLSUtAC0UlLQIKKKWgBKKKKBiEUxlqSkIoAiAp4oxSigAqGTNTUjAGkBSI5oFTPHioiKYhCKbTqCKBgKKSlBoAWkpaKAG4qWJeaZirEK0CLEYwKkpqjiloAWpFpgp4oGOopKKACiikoAWikooAWiiigAooooAKWkooAWikpaACiiigAooooAKKKKACiiigAooooAw8UvFNpcVYheKWkxS4pCFAp2cU2lxQOwZoxSiipuOwoFLSZozSHYWlptGaQx1FIKKAFpaSigBaWkpc00IWkopKYh1LTc0uaAFopKKAFpaSjNAhaWkoFAx1LSCigQtLSZooAWikooGOpKSloAKSlpKAEIpKdTaAClptLmkAHmoXj7ipqKAKhGKbVh0z0qEjFMQ2kIxS0UDEBp1NIpM80ASouTVuMcVXiFW16UCHUtNzSikA9akFMWnUDFpKM0lMBaKSigBaKbmigB1FNzS5oAWlpuaM0AOopKKAFopKKAFooooAKKKKAFopKKAFopKKAFopKKAP/Z'},
                        access_token: @client.auth_token
        end
        json = JSON.parse(response.body)
        assert_equal json.keys, %w(id guest_user_id regular_user_id guest_transaction food_type date price image created_at updated_at)
        assert_includes json['image']['url'], "/uploads/transaction/image/#{json['id']}/image.jpeg"
      end
    end
  end
end
